<!-- CSS da Navbar -->
<link rel="stylesheet" href="assets/global-styles.css">
<link rel="stylesheet" href="navbar.css">

<!-- Script de Dark Mode -->
<script src="assets/dark-mode.js"></script>

<!-- Navbar Principal -->
<nav class="navbar" role="navigation" aria-label="Navega√ß√£o principal">
  <!-- Logo/Brand -->
  <div class="navbar-brand">
    <a href="index.html" class="brand-link">
      <img src="assets/Pearspective-logo.png" alt="Pearspective Logo" class="brand-logo">
      <span class="brand-text">Pearspective</span>
    </a>
  </div>

  <!-- Menu de Navega√ß√£o -->
  <ul class="navbar-menu" role="menubar">
    <li class="navbar-item" role="none">
      <a href="index.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">üè°</span>
        <span class="nav-text">In√≠cio</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="catalogo.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">‚≠ê</span>
        <span class="nav-text">Recomenda√ß√µes</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="biblioteca.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">üîé</span>
        <span class="nav-text">Pesquisar Cursos</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="simulador.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">üéØ</span>
        <span class="nav-text">Simulador</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="historico.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">üèÜ</span>
        <span class="nav-text">Certificados</span>
      </a>
    </li>
  </ul>

  <!-- √Årea do Usu√°rio -->
  <div class="user-area">
    <!-- Bot√£o de Dark Mode -->
    <button class="dark-mode-toggle" id="darkModeToggle" aria-label="Alternar modo escuro" onclick="toggleDarkMode()">
      <span class="icon sun-icon">‚òÄÔ∏è</span>
      <span class="icon moon-icon" style="display: none;">üåô</span>
    </button>
    <!-- C√≠rculo do usu√°rio e menu dropdown -->
    <div class="user-circle-container" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
      <div class="user-circle" id="userCircle" aria-label="Foto do usu√°rio"></div>
      <div class="user-name" id="userNameDisplay" aria-label="Nome do usu√°rio"></div>
      
      <!-- Menu do Usu√°rio -->
      <div class="user-menu" role="menu" aria-label="Menu do usu√°rio">
        <ul class="user-menu-list">
          <li class="user-menu-item" role="none">
            <a href="simulador.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">üéØ</span>
              Simulador
            </a>
          </li>
          <li class="user-menu-item" role="none">
            <a href="biblioteca.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">üìö</span>
              Cursos
            </a>
          </li>
          <li class="user-menu-item" role="none">
            <a href="catalogo.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">‚≠ê</span>
              Recomenda√ß√µes
            </a>
          </li>

          
          <li class="user-menu-divider" role="separator"></li>
          
          <li class="user-menu-item" role="none">
            <a href="historico.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">üèÜ</span>
              Meus Certificados
            </a>
          </li>
          <li class="user-menu-item" role="none">
            <a href="perfil.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">üë§</span>
              Meu Perfil
            </a>
          </li>
          
          <li class="user-menu-divider" role="separator"></li>
          
          <li class="user-menu-item" role="none">
            <label class="photo-upload-label" role="menuitem">
              <span class="menu-icon">üì∏</span>
              Alterar Foto
              <input type="file" id="photoUpload" accept="image/*" class="sr-only" aria-label="Selecionar foto">
            </label>
          </li>
          
          <li class="user-menu-divider" role="separator"></li>
          
          <li class="user-menu-item" role="none">
            <button id="logoutButton" class="user-menu-button" role="menuitem">
              <span class="menu-icon">üö™</span>
              Logoff
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Fun√ß√£o para obter a inicial do usu√°rio
  function getUserInitial() {
    const userName = localStorage.getItem('userName') || 'U';
    return userName.charAt(0).toUpperCase();
  }

  // Fun√ß√£o para atualizar o c√≠rculo do usu√°rio
  function updateUserCircle() {
    const userCircle = document.getElementById('userCircle');
    const userName = localStorage.getItem('userName') || '';
    const userNameDisplay = document.getElementById('userNameDisplay');
    console.log('[NAVBAR] userName lido do localStorage:', userName);
    
    if (userName) {
      // SEMPRE buscar foto do banco de dados primeiro
      fetch(`/api/users/photo/${encodeURIComponent(userName)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Usu√°rio n√£o encontrado');
          }
          return response.json();
        })
        .then(userData => {
          if (userData.foto_perfil) {
            // Atualizar localStorage e exibir foto
            localStorage.setItem('userPhoto', userData.foto_perfil);
            userCircle.innerHTML = `<img src="${userData.foto_perfil}" alt="Foto do usu√°rio">`;
            console.log('[NAVBAR] Foto carregada do banco de dados');
          } else {
            // Se n√£o h√° foto no banco, usar inicial
            localStorage.removeItem('userPhoto');
            userCircle.textContent = getUserInitial();
            console.log('[NAVBAR] Nenhuma foto no banco, usando inicial');
          }
        })
        .catch(error => {
          console.error('[NAVBAR] Erro ao buscar foto do usu√°rio:', error);
          // Fallback para localStorage se dispon√≠vel
          const userPhoto = localStorage.getItem('userPhoto');
          if (userPhoto) {
            userCircle.innerHTML = `<img src="${userPhoto}" alt="Foto do usu√°rio">`;
            console.log('[NAVBAR] Usando foto do localStorage como fallback');
          } else {
            userCircle.textContent = getUserInitial();
            console.log('[NAVBAR] Usando inicial como fallback');
          }
        });
    } else {
      // Se n√£o h√° userName, limpar tudo
      localStorage.removeItem('userPhoto');
      userCircle.textContent = getUserInitial();
      console.log('[NAVBAR] Nenhum usu√°rio logado');
    }
    userNameDisplay.textContent = userName;
  }

  // Fun√ß√£o para lidar com o upload de foto
  document.getElementById('photoUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const photoData = e.target.result;
        localStorage.setItem('userPhoto', photoData);
        updateUserCircle();
        
        // Sincronizar com o banco de dados
        const userName = localStorage.getItem('userName');
        const userId = localStorage.getItem('userId');
        
        if (userName && userId) {
          fetch(`/api/users/profile/${userId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              departamento: localStorage.getItem('userDepartment') || '',
              cargo_atual: localStorage.getItem('userPosition') || '',
              foto_perfil: photoData
            })
          })
          .then(response => response.json())
          .then(updatedUser => {
            console.log('[NAVBAR] Foto sincronizada com o banco:', updatedUser.foto_perfil ? 'Salva' : 'N√£o salva');
          })
          .catch(error => {
            console.error('[NAVBAR] Erro ao sincronizar foto:', error);
          });
        }
      };
      reader.readAsDataURL(file);
    }
  });

  // Fun√ß√£o para lidar com o logout
  document.getElementById('logoutButton').addEventListener('click', function(e) {
    e.preventDefault();
    
    // Remover apenas dados de sess√£o, manter foto como cache
    localStorage.removeItem('userName');
    localStorage.removeItem('userId');
    localStorage.removeItem('tipo_usuario');
    localStorage.removeItem('userDepartment');
    localStorage.removeItem('userPosition');
    
    // N√ÉO remover userPhoto - manter como cache
    console.log('[NAVBAR] Logoff: dados de sess√£o removidos, foto mantida como cache');
    window.location.href = 'login.html';
  });

  // Atualiza o c√≠rculo do usu√°rio ao carregar a p√°gina
  updateUserCircle();

  // ===== DARK MODE FUNCTIONALITY =====
  
  // Fun√ß√£o para alternar o tema (global)
  window.toggleDarkMode = function() {
    console.log('[DARK MODE] Alternando tema...');
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    console.log('[DARK MODE] Tema atual:', currentTheme, 'Novo tema:', newTheme);
    
    // Aplicar o tema
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    // Atualizar √≠cones
    const sunIcon = document.querySelector('.sun-icon');
    const moonIcon = document.querySelector('.moon-icon');
    
    if (sunIcon && moonIcon) {
      if (newTheme === 'dark') {
        sunIcon.style.display = 'none';
        moonIcon.style.display = 'block';
      } else {
        sunIcon.style.display = 'block';
        moonIcon.style.display = 'none';
      }
    }
    
    console.log('[DARK MODE] Tema aplicado:', newTheme);
  };
  
  // Fun√ß√£o para inicializar o tema
  function initializeTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    // Usar tema salvo ou prefer√™ncia do sistema
    const theme = savedTheme || (prefersDark ? 'dark' : 'light');
    
    console.log('[DARK MODE] Inicializando tema:', theme);
    
    document.documentElement.setAttribute('data-theme', theme);
    
    // Atualizar √≠cones
    const sunIcon = document.querySelector('.sun-icon');
    const moonIcon = document.querySelector('.moon-icon');
    
    if (sunIcon && moonIcon) {
      if (theme === 'dark') {
        sunIcon.style.display = 'none';
        moonIcon.style.display = 'block';
      } else {
        sunIcon.style.display = 'block';
        moonIcon.style.display = 'none';
      }
    }
  }
  
  // Inicializar tema
  initializeTheme();
});
</script>

<!-- CSS da Navbar -->
<link rel="stylesheet" href="assets/global-styles.css">
<link rel="stylesheet" href="navbar.css">

<!-- Script de Dark Mode -->
<script src="assets/dark-mode.js"></script>

<!-- Navbar Principal -->
<nav class="navbar" role="navigation" aria-label="Navega√ß√£o principal">
  <!-- Logo/Brand -->
  <div class="navbar-brand">
    <a href="index.html" class="brand-link">
      <img src="assets/Pearspective-logo.png" alt="Pearspective Logo" class="brand-logo">
      <span class="brand-text">Pearspective</span>
    </a>
  </div>

  <!-- Menu de Navega√ß√£o -->
  <ul class="navbar-menu" role="menubar">
    <li class="navbar-item" role="none">
      <a href="index.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">üè°</span>
        <span class="nav-text">In√≠cio</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="catalogo.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">‚≠ê</span>
        <span class="nav-text">Recomenda√ß√µes</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="biblioteca.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">üîé</span>
        <span class="nav-text">Pesquisar Cursos</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="simulador.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">üéØ</span>
        <span class="nav-text">Simulador</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="historico.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">üèÜ</span>
        <span class="nav-text">Certificados</span>
      </a>
    </li>
  </ul>

  <!-- √Årea do Usu√°rio -->
  <div class="user-area">
    <!-- Bot√£o de Dark Mode -->
    <button class="dark-mode-toggle" id="darkModeToggle" aria-label="Alternar modo escuro" onclick="toggleDarkMode()">
      <span class="icon sun-icon">‚òÄÔ∏è</span>
      <span class="icon moon-icon" style="display: none;">üåô</span>
    </button>
    <!-- C√≠rculo do usu√°rio e menu dropdown -->
    <div class="user-circle-container" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
      <div class="user-circle" id="userCircle" aria-label="Foto do usu√°rio"></div>
      <div class="user-name" id="userNameDisplay" aria-label="Nome do usu√°rio"></div>
      
      <!-- Menu do Usu√°rio -->
      <div class="user-menu" role="menu" aria-label="Menu do usu√°rio">
        <ul class="user-menu-list">
          <li class="user-menu-item" role="none">
            <a href="simulador.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">üéØ</span>
              Simulador
            </a>
          </li>
          <li class="user-menu-item" role="none">
            <a href="biblioteca.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">üìö</span>
              Cursos
            </a>
          </li>
          <li class="user-menu-item" role="none">
            <a href="catalogo.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">‚≠ê</span>
              Recomenda√ß√µes
            </a>
          </li>

          
          <li class="user-menu-divider" role="separator"></li>
          
          <li class="user-menu-item" role="none">
            <a href="historico.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">üèÜ</span>
              Meus Certificados
            </a>
          </li>
          <li class="user-menu-item" role="none">
            <a href="perfil.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">üë§</span>
              Meu Perfil
            </a>
          </li>
          
          <li class="user-menu-divider" role="separator"></li>
          
          <li class="user-menu-item" role="none">
            <label class="photo-upload-label" role="menuitem">
              <span class="menu-icon">üì∏</span>
              Alterar Foto
              <input type="file" id="photoUpload" accept="image/*" class="sr-only" aria-label="Selecionar foto">
            </label>
          </li>
          
          <li class="user-menu-divider" role="separator"></li>
          
          <li class="user-menu-item" role="none">
            <button id="logoutButton" class="user-menu-button" role="menuitem">
              <span class="menu-icon">üö™</span>
              Logoff
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<script>
// Fun√ß√£o para obter a inicial do usu√°rio
function getUserInitial(nome) {
  if (!nome) return 'U';
  return nome.charAt(0).toUpperCase();
}

// Fun√ß√£o para atualizar o c√≠rculo do usu√°rio usando Railway
async function updateUserCircle() {
  const userCircle = document.getElementById('userCircle');
  const userNameDisplay = document.getElementById('userNameDisplay');
  
  console.log('[NAVBAR] Verificando sess√£o atual...');
  
  if (userCircle) {
    try {
      // Buscar dados do banco do Railway
      const response = await fetch('/api/me', {
        credentials: 'include' // Incluir cookies
      });
      
      if (response.ok) {
        const sessionData = await response.json();
        console.log('[NAVBAR] Sess√£o v√°lida:', sessionData.user?.nome);
        
        if (sessionData.authenticated && sessionData.user) {
          const user = sessionData.user;
          console.log('[NAVBAR] Dados do usu√°rio recebidos:', user);
          
          // Foto
          if (user.foto_perfil) {
            userCircle.innerHTML = `<img src="${user.foto_perfil}" alt="Foto do usu√°rio">`;
            console.log('[NAVBAR] Foto carregada do banco de dados');
          } else {
            userCircle.textContent = getUserInitial(user.nome);
            console.log('[NAVBAR] Nenhuma foto no banco, usando inicial');
          }
          // Nome de exibi√ß√£o
          if (userNameDisplay) {
            userNameDisplay.textContent = user.nome;
          }
        } else {
          console.error('[NAVBAR] Dados de sess√£o inv√°lidos:', sessionData);
          userCircle.textContent = getUserInitial();
          if (userNameDisplay) userNameDisplay.textContent = '';
          // Redirecionar para login se n√£o estiver na p√°gina de login
          if (!window.location.pathname.includes('login.html')) {
            console.log('[NAVBAR] Redirecionando para login...');
            window.location.href = '/login.html';
          }
        }
      } else {
        console.log('[NAVBAR] Sess√£o inv√°lida ou expirada');
        userCircle.textContent = getUserInitial();
        if (userNameDisplay) userNameDisplay.textContent = '';
        if (!window.location.pathname.includes('login.html')) {
          console.log('[NAVBAR] Redirecionando para login...');
          window.location.href = '/login.html';
        }
      }
    } catch (error) {
      console.error('[NAVBAR] Erro ao verificar sess√£o:', error);
      userCircle.textContent = getUserInitial();
      if (userNameDisplay) userNameDisplay.textContent = '';
      if (!window.location.pathname.includes('login.html')) {
        console.log('[NAVBAR] Redirecionando para login devido a erro...');
        window.location.href = '/login.html';
      }
    }
  }
}

// Fun√ß√£o para lidar com o logout
const logoutBtn = document.getElementById('logoutButton');
if (logoutBtn) {
  logoutBtn.addEventListener('click', async function(e) {
    e.preventDefault();
    try {
      // Chamar API para fazer logout (limpar cookie)
      await fetch('/api/logout', {
        method: 'POST',
        credentials: 'include'
      });
      console.log('[NAVBAR] Logout realizado com sucesso');
    } catch (error) {
      console.error('[NAVBAR] Erro ao fazer logout:', error);
    }
    // Redirecionar para login
    window.location.href = '/login.html';
  });
}

// Atualiza o c√≠rculo do usu√°rio ao carregar a p√°gina
updateUserCircle();

// ===== DARK MODE FUNCTIONALITY =====
// Fun√ß√£o para alternar o tema (global)
window.toggleDarkMode = function() {
  console.log('[DARK MODE] Alternando tema...');
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme') || 'light';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  // Atualizar √≠cones
  const sunIcon = document.querySelector('.sun-icon');
  const moonIcon = document.querySelector('.moon-icon');
  if (sunIcon && moonIcon) {
    if (newTheme === 'dark') {
      sunIcon.style.display = 'none';
      moonIcon.style.display = 'block';
    } else {
      sunIcon.style.display = 'block';
      moonIcon.style.display = 'none';
    }
  }
  console.log('[DARK MODE] Tema aplicado:', newTheme);
};
// Fun√ß√£o para inicializar o tema
function initializeTheme() {
  const savedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = savedTheme || (prefersDark ? 'dark' : 'light');
  document.documentElement.setAttribute('data-theme', theme);
  // Atualizar √≠cones
  const sunIcon = document.querySelector('.sun-icon');
  const moonIcon = document.querySelector('.moon-icon');
  if (sunIcon && moonIcon) {
    if (theme === 'dark') {
      sunIcon.style.display = 'none';
      moonIcon.style.display = 'block';
    } else {
      sunIcon.style.display = 'block';
      moonIcon.style.display = 'none';
    }
  }
}
// Inicializar tema
initializeTheme();
</script>

<!-- CSS da Navbar -->
<link rel="stylesheet" href="../assets/global-styles.css">
<link rel="stylesheet" href="../navbar.css">

<!-- Navbar Principal -->
<nav class="navbar" role="navigation" aria-label="Navega칞칚o principal">
  <!-- Logo/Brand -->
  <div class="navbar-brand">
    <a href="../Page_inicial/index.html" class="brand-link">
      <img src="../assets/Pearspective-logo.png" alt="Pearspective Logo" class="brand-logo">
      <span class="brand-text">Pearspective</span>
    </a>
  </div>

  <!-- Menu de Navega칞칚o -->
  <ul class="navbar-menu" role="menubar">
    <li class="navbar-item" role="none">
      <a href="../Page_inicial/index.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">游</span>
        <span class="nav-text">In칤cio</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="../catalogo/catalogo.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">游눠</span>
        <span class="nav-text">Recomenda칞칫es</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="../biblioteca/biblioteca.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">游댌</span>
        <span class="nav-text">Pesquisar Cursos</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="../simulador/simulador.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">游꿢</span>
        <span class="nav-text">Simulador</span>
      </a>
    </li>
    <li class="navbar-item" role="none">
      <a href="../historico/historico.html" class="navbar-link" role="menuitem">
        <span class="nav-icon">游닆</span>
        <span class="nav-text">Certificados</span>
      </a>
    </li>
  </ul>

  <!-- 츼rea do Usu치rio -->
  <div class="user-area">
    <!-- C칤rculo do usu치rio e menu dropdown -->
    <div class="user-circle-container" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
      <div class="user-circle" id="userCircle" aria-label="Foto do usu치rio"></div>
      <div class="user-name" id="userNameDisplay" aria-label="Nome do usu치rio"></div>
      
      <!-- Menu do Usu치rio -->
      <div class="user-menu" role="menu" aria-label="Menu do usu치rio">
        <ul class="user-menu-list">
          <li class="user-menu-item" role="none">
            <a href="../simulador/simulador.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">游꿢</span>
              Simulador
            </a>
          </li>
          <li class="user-menu-item" role="none">
            <a href="../biblioteca/biblioteca.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">游닄</span>
              Cursos
            </a>
          </li>
          <li class="user-menu-item" role="none">
            <a href="../recomendacoes.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">游눠</span>
              Recomenda칞칫es
            </a>
          </li>

          
          <li class="user-menu-divider" role="separator"></li>
          
          <li class="user-menu-item" role="none">
            <a href="../historico/historico.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">游닆</span>
              Meus Certificados
            </a>
          </li>
          <li class="user-menu-item" role="none">
            <a href="../perfil/perfil.html" class="user-menu-link" role="menuitem">
              <span class="menu-icon">游녻</span>
              Meu Perfil
            </a>
          </li>
          
          <li class="user-menu-divider" role="separator"></li>
          
          <li class="user-menu-item" role="none">
            <label class="photo-upload-label" role="menuitem">
              <span class="menu-icon">游닝</span>
              Alterar Foto
              <input type="file" id="photoUpload" accept="image/*" class="sr-only" aria-label="Selecionar foto">
            </label>
          </li>
          
          <li class="user-menu-divider" role="separator"></li>
          
          <li class="user-menu-item" role="none">
            <button id="logoutButton" class="user-menu-button" role="menuitem">
              <span class="menu-icon">游뛁</span>
              Logoff
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Fun칞칚o para obter a inicial do usu치rio
  function getUserInitial() {
    const userName = localStorage.getItem('userName') || 'U';
    return userName.charAt(0).toUpperCase();
  }

  // Fun칞칚o para atualizar o c칤rculo do usu치rio
  function updateUserCircle() {
    const userCircle = document.getElementById('userCircle');
    const userName = localStorage.getItem('userName') || '';
    const userNameDisplay = document.getElementById('userNameDisplay');
    console.log('[NAVBAR] userName lido do localStorage:', userName);
    
    if (userName) {
      // SEMPRE buscar foto do banco de dados primeiro
      fetch(`/api/users/photo/${encodeURIComponent(userName)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Usu치rio n칚o encontrado');
          }
          return response.json();
        })
        .then(userData => {
          if (userData.foto_perfil) {
            // Atualizar localStorage e exibir foto
            localStorage.setItem('userPhoto', userData.foto_perfil);
            userCircle.innerHTML = `<img src="${userData.foto_perfil}" alt="Foto do usu치rio">`;
            console.log('[NAVBAR] Foto carregada do banco de dados');
          } else {
            // Se n칚o h치 foto no banco, usar inicial
            localStorage.removeItem('userPhoto');
            userCircle.textContent = getUserInitial();
            console.log('[NAVBAR] Nenhuma foto no banco, usando inicial');
          }
        })
        .catch(error => {
          console.error('[NAVBAR] Erro ao buscar foto do usu치rio:', error);
          // Fallback para localStorage se dispon칤vel
          const userPhoto = localStorage.getItem('userPhoto');
          if (userPhoto) {
            userCircle.innerHTML = `<img src="${userPhoto}" alt="Foto do usu치rio">`;
            console.log('[NAVBAR] Usando foto do localStorage como fallback');
          } else {
            userCircle.textContent = getUserInitial();
            console.log('[NAVBAR] Usando inicial como fallback');
          }
        });
    } else {
      // Se n칚o h치 userName, limpar tudo
      localStorage.removeItem('userPhoto');
      userCircle.textContent = getUserInitial();
      console.log('[NAVBAR] Nenhum usu치rio logado');
    }
    userNameDisplay.textContent = userName;
  }

  // Fun칞칚o para lidar com o upload de foto
  document.getElementById('photoUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const photoData = e.target.result;
        localStorage.setItem('userPhoto', photoData);
        updateUserCircle();
        
        // Sincronizar com o banco de dados
        const userName = localStorage.getItem('userName');
        const userId = localStorage.getItem('userId');
        
        if (userName && userId) {
          fetch(`/api/users/profile/${userId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              nome: userName,
              departamento: localStorage.getItem('userDepartment') || '',
              cargo_atual: localStorage.getItem('userPosition') || '',
              foto_perfil: photoData
            })
          })
          .then(response => response.json())
          .then(updatedUser => {
            console.log('[NAVBAR] Foto sincronizada com o banco:', updatedUser.foto_perfil ? 'Salva' : 'N칚o salva');
          })
          .catch(error => {
            console.error('[NAVBAR] Erro ao sincronizar foto:', error);
          });
        }
      };
      reader.readAsDataURL(file);
    }
  });

  // Fun칞칚o para lidar com o logout
  document.getElementById('logoutButton').addEventListener('click', function(e) {
    e.preventDefault();
    
    // Remover apenas dados de sess칚o, manter foto como cache
    localStorage.removeItem('userName');
    localStorage.removeItem('userId');
    localStorage.removeItem('tipo_usuario');
    localStorage.removeItem('userDepartment');
    localStorage.removeItem('userPosition');
    
    // N츾O remover userPhoto - manter como cache
    console.log('[NAVBAR] Logoff: dados de sess칚o removidos, foto mantida como cache');
    window.location.href = '/login.html';
  });

  // Atualiza o c칤rculo do usu치rio ao carregar a p치gina
  updateUserCircle();
});
</script>
